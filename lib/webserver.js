// Generated by CoffeeScript 1.3.3
(function() {
  var Config, Identity, Logger, RedisUtils, WebServer, formidable, fs, generate_identity, restify, _ref,
    __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  Logger = require('./logger');

  Config = require('./config');

  restify = require('restify');

  _ref = require('./identity'), Identity = _ref.Identity, generate_identity = _ref.generate_identity;

  RedisUtils = require('./redisutils');

  fs = require('fs');

  formidable = require('formidable');

  /**
   * The iOS-ota webserver command line interface class.
  */


  WebServer = (function() {

    function WebServer(port, pkg_info) {
      this.port = port != null ? port : 8080;
      this.pkg_info = pkg_info;
      this.setup_routing = __bind(this.setup_routing, this);

      this.config = Config.get();
      this.logger = Logger.get();
      this.identity = Identity.get();
      this.redis = RedisUtils.get();
      this.app = restify.createServer();
      this.setup_routing();
      this.app.listen(this.port);
      this.logger.info("Webserver is up at: http://0.0.0.0:" + this.port);
    }

    WebServer.prototype.setup_routing = function() {
      var _this = this;
      this.app.get('/', function(req, res) {
        return res.json(200, {
          name: _this.pkg_info.name,
          version: _this.pkg_info.version
        });
      });
      this.app.get('/users', function(req, res) {
        return _this.redis.get_users(function(err, reply) {
          if (err) {
            return res.json(500, {
              message: reply
            });
          }
          return res.json(200, {
            users: reply ? reply : []
          });
        });
      });
      return this.app.post('/users', function(req, res) {
        _this.logger.info(req.params.user);
        return res.json(200, {
          name: "ok"
        });
      });
    };

    return WebServer;

  })();

  module.exports = WebServer;

}).call(this);
